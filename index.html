<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Naijpedia - Nigerian News & Knowledge Hub</title>
  <meta name="description" content="Latest Nigerian news and comprehensive knowledge search">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif; background: #000; color: #fff; overflow-x: hidden; min-height: 100vh; }
    .glass { background: rgba(255,255,255,0.05); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px); border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 8px 32px 0 rgba(0,0,0,0.3); }
    .glass-card { background: rgba(255,255,255,0.05); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 8px 32px 0 rgba(0,0,0,0.3); transition: all 0.3s cubic-bezier(0.4,0,0.2,1); }
    .thumbnail { width: 100%; height: 220px; object-fit: cover; border-radius: 16px; }
    .animate-spin { animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hidden { display: none !important; }
    .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .line-clamp-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
    .shimmer { background: linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
  </style>
</head>
<body>
  <div class="min-h-screen">
    <!-- header / search / content (same structure as before) -->
    <header class="search-container">
      <div class="max-w-7xl mx-auto px-4">
        <div class="flex flex-col gap-4">
          <div class="flex items-center justify-between">
            <h1 class="text-3xl font-bold text-white tracking-tight">Naijpedia</h1>
            <p class="text-white text-opacity-80 text-sm hidden md:block">Your Gateway to Nigerian Information</p>
          </div>

          <div class="glass rounded-2xl p-1.5">
            <div class="flex items-center gap-3 px-4">
              <svg class="text-white" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
              </svg>
              <input id="searchInput" type="text" placeholder="Search for knowledge, history, people, culture..." class="flex-1 bg-transparent border-none outline-none py-3 text-white placeholder-gray-400" onkeypress="if(event.key==='Enter') performKnowledgeSearch()" />
              <button id="searchBtn" onclick="performKnowledgeSearch()" class="px-6 py-2.5 bg-white text-black rounded-xl font-medium hover:bg-gray-200 transition-all">Search</button>
            </div>
          </div>
        </div>
      </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8">
      <section id="knowledgeResults" class="mb-12 hidden">
        <button onclick="closeKnowledgeSearch()" class="mb-6 glass text-white px-4 py-2 rounded-xl">Back to News</button>
        <div class="glass-card p-8 mb-8">
          <h2 class="text-2xl font-bold text-white">AI Overview</h2>
          <div id="aiOverview" class="text-gray-300 text-lg leading-relaxed"></div>
        </div>
        <div id="wikiResults" class="space-y-6"></div>
      </section>

      <section id="newsSection">
        <div class="flex items-center justify-between mb-8">
          <h2 class="text-3xl font-bold text-white">Latest Nigerian News</h2>
          <button onclick="refreshNews()" class="glass text-white px-4 py-2 rounded-xl">Refresh</button>
        </div>

        <div id="newsLoading" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <div class="glass-card p-6">
            <div class="shimmer h-48 rounded-xl mb-4"></div>
            <div class="shimmer h-6 rounded mb-2"></div>
            <div class="shimmer h-4 rounded w-3/4"></div>
          </div>
        </div>

        <div id="newsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden"></div>
        <div id="newsError" class="glass-card p-8 text-center hidden">
          <p class="text-gray-300 text-lg mb-4">Unable to load news at the moment</p>
          <button onclick="refreshNews()" class="px-6 py-3 bg-white text-black rounded-xl">Try Again</button>
        </div>
      </section>
    </main>

    <footer class="mt-24 py-8 border-t border-white border-opacity-20 text-center">
      <p class="text-white text-opacity-80 text-sm">Â© 2025 Naijpedia. All rights reserved.</p>
    </footer>
  </div>

  <script>
    // Client JS: calls your server endpoints (no API keys here)
    let allNews = [];

    async function init() { await fetchLatestNews(); }

    async function fetchLatestNews() {
      const newsLoading = document.getElementById('newsLoading');
      const newsGrid = document.getElementById('newsGrid');
      const newsError = document.getElementById('newsError');

      newsLoading.classList.remove('hidden');
      newsGrid.classList.add('hidden');
      newsError.classList.add('hidden');

      try {
        const resp = await fetch('/api/news?country=ng&language=en&size=15');
        if (!resp.ok) throw new Error('News proxy error');
        const data = await resp.json();
        if (!data.results || data.results.length === 0) throw new Error('No news available');

        allNews = data.results
          .filter(a => a.title && a.title !== '[Removed]')
          .map(a => ({
            title: a.title,
            description: a.description || 'Read more at source',
            url: a.link,
            source: a.source_id || 'News Source',
            date: formatDate(a.pubDate),
            image: a.image_url,
            category: determineCategory(a.title + ' ' + (a.description || ''))
          }));

        renderNews();
      } catch (err) {
        console.error('Error fetching news:', err);
        document.getElementById('newsLoading').classList.add('hidden');
        document.getElementById('newsError').classList.remove('hidden');
      }
    }

    function renderNews() {
      const newsLoading = document.getElementById('newsLoading');
      const newsGrid = document.getElementById('newsGrid');
      newsLoading.classList.add('hidden');
      newsGrid.classList.remove('hidden');

      newsGrid.innerHTML = allNews.map((article, i) => `
        <article class="glass-card p-6" style="animation-delay:${i * 0.05}s">
          ${article.image ? `<img src="${escapeAttr(article.image)}" alt="${escapeHtml(article.title)}" class="thumbnail mb-4" onerror="this.style.display='none'">` : ''}
          <div class="mb-3"><span class="category-badge badge-${article.category}">${escapeHtml(article.category)}</span></div>
          <h3 class="text-xl font-bold text-white mb-3 line-clamp-2">${escapeHtml(article.title)}</h3>
          <p class="text-gray-300 mb-4 line-clamp-3">${escapeHtml(article.description)}</p>
          <div class="flex items-center justify-between pt-4 border-t border-white border-opacity-10">
            <div><span class="text-xs font-semibold text-white">${escapeHtml(article.source)}</span><br/><span class="text-xs text-gray-400">${escapeHtml(article.date)}</span></div>
            <a href="${escapeAttr(article.url)}" target="_blank" rel="noopener noreferrer" class="px-4 py-2 bg-white text-black rounded-lg">Read</a>
          </div>
        </article>
      `).join('');
    }

    function refreshNews() { fetchLatestNews(); }

    async function performKnowledgeSearch() {
      const query = document.getElementById('searchInput').value.trim();
      if (!query) return;
      document.getElementById('newsSection').classList.add('hidden');
      document.getElementById('knowledgeResults').classList.remove('hidden');
      document.getElementById('aiOverview').innerHTML = '<div class="animate-spin">Generating...</div>';
      document.getElementById('wikiResults').innerHTML = '<div class="animate-spin">Searching Wikipedia...</div>';

      try {
        const wikiData = await searchWikipedia(query);
        const aiResp = await fetch('/api/ai-summary', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query, wikiResults: wikiData })
        });
        if (!aiResp.ok) throw new Error('AI summary proxy error');
        const aiJson = await aiResp.json();
        document.getElementById('aiOverview').textContent = aiJson.summary || (wikiData.length ? `Found ${wikiData.length} Wikipedia articles.` : `No detailed info available.`);

        if (wikiData.length) {
          document.getElementById('wikiResults').innerHTML = wikiData.map(r => `
            <div class="glass-card p-6">
              <h4 class="text-xl font-bold text-white mb-3">${escapeHtml(r.title)}</h4>
              <p class="text-gray-300 mb-4">${escapeHtml(r.snippet)}</p>
              <a href="${escapeAttr(r.url)}" target="_blank" class="px-4 py-2 bg-white text-black rounded-lg">Read on Wikipedia</a>
            </div>
          `).join('');
        } else {
          document.getElementById('wikiResults').innerHTML = '<div class="glass-card p-8 text-center"><p class="text-gray-300">No Wikipedia articles found for this query.</p></div>';
        }
      } catch (err) {
        console.error('Knowledge search error:', err);
        document.getElementById('aiOverview').textContent = 'Unable to generate overview at this time.';
        document.getElementById('wikiResults').innerHTML = '<div class="glass-card p-8">Unable to fetch articles. Please try again.</div>';
      }
    }

    function closeKnowledgeSearch() {
      document.getElementById('newsSection').classList.remove('hidden');
      document.getElementById('knowledgeResults').classList.add('hidden');
      document.getElementById('searchInput').value = '';
    }

    async function searchWikipedia(query) {
      try {
        const endpoint = `https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(query)}&format=json&origin=*&srlimit=5`;
        const resp = await fetch(endpoint);
        const data = await resp.json();
        if (!data.query || !data.query.search) return [];
        return data.query.search.map(r => ({ title: r.title, snippet: r.snippet.replace(/<[^>]*>/g, ''), url: `https://en.wikipedia.org/wiki/${encodeURIComponent(r.title.replace(/ /g, '_'))}` }));
      } catch (err) {
        console.error('Wikipedia search error:', err);
        return [];
      }
    }

    function determineCategory(text) {
      const lower = (text || '').toLowerCase();
      if (lower.includes('tech') || lower.includes('startup') || lower.includes('ai') || lower.includes('fintech')) return 'tech';
      if (lower.includes('sport') || lower.includes('football') || lower.includes('afcon')) return 'sports';
      if (lower.includes('grant') || lower.includes('scholarship')) return 'grants';
      if (lower.includes('job') || lower.includes('vacancy') || lower.includes('hiring')) return 'jobs';
      return 'news';
    }

    function formatDate(d) {
      if (!d) return 'Recently';
      try {
        const date = new Date(d);
        if (isNaN(date.getTime())) return 'Recently';
        const now = new Date();
        const diffDays = Math.floor((now - date) / (1000*60*60*24));
        if (diffDays === 0) return 'Today';
        if (diffDays === 1) return 'Yesterday';
        if (diffDays < 7) return `${diffDays} days ago`;
        if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
        return date.toLocaleDateString();
      } catch(e) { return 'Recently'; }
    }

    function escapeHtml(s) { return s ? String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;') : ''; }
    function escapeAttr(s) { return s ? String(s).replace(/"/g,'&quot;').replace(/'/g,'&#39;') : '#'; }

    init();
  </script>
</body>
</html>
